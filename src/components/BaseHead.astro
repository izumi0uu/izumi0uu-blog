---

// load fonts and font utils
import FontLoader from "@/components/fonts/FontLoader.astro";
import GoogleFontsLoader from "@/components/fonts/GoogleFontsLoader.astro";
import FontUtils from "@/components/fonts/FontUtils.astro";

// load styles
import '@/styles/main.css';

// load default metadata
import { DEFAULT_METADATA } from "@/constants/metadata";

// load config
import { CONFIG_CLIENT } from "@/config/client";

// load transitions
import { ClientRouter } from "astro:transitions";

// load theme-script component
import ThemeScript from '@/components/ThemeScript.astro';

// load utils
import { handleMetadataTitle } from "@/utils/content/metadata";
import { filterUndefined } from "@/utils/data/objects";

// load types
import type { Metadata } from "@/types/common";

const {SITE_URL_CANONICAL, SITE_TITLE, SITE_DESCRIPTION, AUTHOR_NAME, PLAUSIBLE_DOMAIN, PLAUSIBLE_SCRIPT_URL} = CONFIG_CLIENT;

export interface BaseHeadProps {
  metadata: Metadata;
}

/**
 * @description receive every single metadata from every single specific page
 *  <html lang="en">
 *    // pass metadata to BaseHead
 *    <BaseHead metadata={metadata} /> 
 *    <body>
 *      // page content
 *      <slot /> 
 *    </body>
 *  </html>
 */
const { metadata } = Astro.props as BaseHeadProps;

// site: SITE_URL var + '/', SITE_URL changed by environment
// url: current page url, per page
const { url } = Astro; // objects
const { host, pathname, search } = url; // host - izumi0uu.com

// replace host - all deployments point to single canonical deployment url
const canonicalUrl = new URL(`${pathname}${search}`, SITE_URL_CANONICAL);

const handledMetadata = handleMetadataTitle(metadata);

const filteredMetadata = filterUndefined(handledMetadata)
const mergedMetadata: Required<Metadata> = { ...DEFAULT_METADATA, ...filteredMetadata };

const { title, description, image } = mergedMetadata;

// convert to absolute url
const ogImageUrl = new URL(image, url);

---

<head>
  <meta charset="utf-utf-8" /> 
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <meta name="theme-color" content="" />

  <meta name="generator" content={Astro.generator} />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="manifest" href="/manifest.json" />

  {/* Primary Meta Tags */}
  <title>{SITE_TITLE}</title>
  <meta name="title" content={SITE_TITLE} />
  <meta name="description" content={SITE_DESCRIPTION} />
  <meta name="author" content={AUTHOR_NAME} />
  <link rel="canonical" href={SITE_URL_CANONICAL} />

  {/* Open Graph / Facebook */}
  <meta property="og:type" content="website" />
  <meta property="og:url" content={url} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={ogImageUrl} />


  {/* Analytics */}
  {
    PLAUSIBLE_SCRIPT_URL && (
      <>
        <link rel="preconnect" href={PLAUSIBLE_SCRIPT_URL} />
        {/* PLAUSIBLE_DOMAIN must be the same for all mirrors */}
        <script
          defer
          type="text/partytown"
          src={PLAUSIBLE_SCRIPT_URL}
          data-domain={PLAUSIBLE_DOMAIN}
        />
      </>
    )
  }

  {/* Theme */}
  {/* MUST be inside <head /> to avoid white flash, IMPORTANT */}
  <ThemeScript />

  {/* turn on the feature of view transitions in Astro */}
  <ClientRouter fallback="none" />

  {/* Load local fonts (Inter + JetBrains Mono) */}
  <FontLoader />
  
  {/* Load Chinese fonts (Noto Sans SC) */}
  <GoogleFontsLoader />
  
  {/* Load font utility classes */}
  <FontUtils />
</head>
